---
title: 6장. Job 상태 관리
date: 2022-11-11
type:  blog
author: harris baek
email: baekjh09@naver.com
---
tags: #kotlin, #language, #concurrent, #coroutine 

### Job의 상태
Job의 상태는 생성 (New), 실행 중 (Active), 실행 완료 (Completed), 취소 중(Cancelling), 취소 완료(Cancelled) 총 5가지 이다.

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2FlDPEY%2FbtrcOkr0Ne2%2FphWZLmmhFhkehvIzIEb8G1%2Fimg.png)

-   생성(New) : Job이 생성된다.
-   실행 중(Active) : Job이 실행 중이다.
-   실행 완료(Completed) : Job의 실행이 완료되었다.
-   취소 중(Cancelling) : Job이 취소되는 중이다. Job이 취소되면 리소스 반환 등의 작업을 해야 하기 때문에 취소 중 상태가 있다. 
-   취소 완료(Cancelled) : Job의 취소가 완료되었다.


### 앞선 글에서 다룬 내용 : Job의 생성과 실행
앞선 글에서 우리는 Job의 생성과 실행을 다루었다.

-   launch를 통한 Job의 생성 및 실행
-   launch에 CoroutineStart.LAZY 옵션을 추가하여 Job을 바로 실행되지 않게 만들기
-   CoroutineStart.LAZY로 생성된 Job을 시작하는 방법 : start(),join()

위와 같은 과정을 거쳐 생성 및 실행된 Job은 일반적으로 작업이 끝나면 실행완료 상태가 된 다음 종료된다.

### 실행 완료가 되지 않는다면?
**하지만, Job은 항상 실행에 성공하여 실행 완료 상태가 되지는 않는다. 다양한 변수로 인해 중간에 취소되어야 할 수 있다.**

예를 들어보자. 네트워크를 통해 유저의 정보를 달라는 요청을 했을 때, 우리는 요청의 결과를 기다려야한다. <그림2>과 같이 서버에서 요청이 성공되거나 거부되었다는 메세지를 보내주면 Job은 실행에 성공하여 종료될 것이다.
![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2Fv4fNA%2FbtrcLBB0H2G%2F10LNc5co46tiTLwI3XUNC1%2Fimg.png)

하지만 만약 서버에서 결과를 주지 않는다면 <그림3>과 같이 우리는 계속해서 응답을 기다리고 있어야 한다.
![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2Fdk2bEE%2FbtrcNJyWaPq%2FxysFUCL5DfftkZ6NG3kSt0%2Fimg.png)

이러한 상황에서는 일정 시간 이후에 Job을 취소하는 작업이 필요하다. 또한 Job을 취소했을 때 생기는 Exception에 대한 Handling이 필요하다. 이재ㅔ 부터 Job을 취소하는 방법과 Exception을 Handling하는 방법을 알아보자.


### Cancel()을 이용한 Job의 취소
job을 취소하는 것은 간단하다. 아래의 코드와 같이 **cancel()을 이용해 job을 취소**할 수 있다.

```kotlin
suspend fun main() { 
	val job = CoroutineScope(Dispatchers.IO).launch { delay(1000) } 
	job.cancel() 
	delay(3000) 
}
```

하지만 그냥 취소를 해주면 원인을 알 수 없으니, 취소가 된 원인을 인자로 넣어보자.



### Cancel()에 cancel된 원인 넣고 원인 출력하기
cancel()에 두가지 인자 message : String과 cause : Throwable을 넘기는 것으로 취소의 원인을 알릴 수 있다.

또한 Job에 getCancellationException()메서드를 사용함으로써 취소의 원인을 알 수 있게 된다.

```kotlin
suspend fun main() {  
    val job = CoroutineScope(Dispatchers.IO).launch {  
        delay(1000)  
    }  
    job.cancel("Job Cancelled by User", InterruptedException("Cancelled Forcibly")) // cacnel 원인 넘기기  
    println(job.getCancellationException()) // cancel 원인 출력  
    delay(3000)  
}
```


### cancel 되었을 때 동작 Handling 하기
cancel된 원인을 Handling하는 것은 간단하다. Job가 취소 완료 될 때 invokeOnCompletion 내의 메서드가 호출이 되는데 이를 활용하여 애러를 핸들링한다.

```kotlin
suspend fun main() {  
    val job = CoroutineScope(Dispatchers.IO).launch {  
        delay(1000)  
    }  
    //취소된 원인 handling  
    job.invokeOnCompletion { throwable ->  
        println(throwable)  
    }  
    job.cancel("Job Cancelled by User", InterruptedException("Cancelled Forcibly")) // cacnel 원인 넘기기  
    delay(3000)  
}
```

위 코드에서 job.invokeOnCompletion 에서 throwable을 받고 해당 throwable을 출력할 수 있다. throwable은 InterrupedException을 넘기더라도 Cancellation Exception으로 잡힌다.

```kotlin
suspend fun main() {  
    val job = CoroutineScope(Dispatchers.IO).launch {  
        delay(1000)  
    }  
  
    //취소된 원인 handling  
    job.invokeOnCompletion { throwable ->  
        when(throwable){  
            is CancellationException -> println("Cancelled")  
            null -> println("Completed with no error")  
        }  
    }  
  
    delay(3000)  
}
```


### Job의 상태 변수 :  isActive, isCancelled, isCompleted
Job의 상태변수는 세가지가 있는데 아래와 같다.
-   isActive: Job이 **실행중**인지 여부를 표시
-   isCancelled: Job **cancel이 요청**되었는지 여부를 표시
-   isCompleted: Job의 **실행이 완료되었거나 cancel이 완료었는지를 표시**


|                      | isActive | isCancelled | isCompleted |
| -------------------- | -------- | ----------- | ----------- |
| 생성됨(new)          | false    | false       | false       |
| 실행 중(Active)      | true     | false       | false       |
| 실행 완료(Completed) | false    | false       | true        |
| 취소 중(Cancelling)  | false    | true        | false       |
| 취소 완료(Cancelled) | false    | true        | true        | 


