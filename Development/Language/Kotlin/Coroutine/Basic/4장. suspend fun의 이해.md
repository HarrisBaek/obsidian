---
title: 4장 suspend fun의 이해
date: 2022-11-11
type:  blog
author: harris baek
email: baekjh09@naver.com
---
tags: #kotlin, #language, #concurrent, #coroutine 

### 일시 중단 가능한 코루틴
코루틴은 기본적으로 일시 중단 가능하다. launch로 실행하든 async로 실행하든 내부에 해당 코루틴을 일시중단 해야하는 동작이 잇으면 코루틴은 일시 중단된다.

### 예시로 보는 일시 중단
일시 중단 가능하다는 것이 무엇인지 알기 위해 아래 그림을 보자
![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2FTn8jv%2FbtrcLA3WFQl%2F2XLWwOC68ZtORSdUlCNBck%2Fimg.png)

```kotlin 
fun exampleSuspend(){  
    val job3 = CoroutineScope(Dispatchers.IO).async {  
        // 2. IO Thread에서 작업3를 수행한다.  
        (1..10000).sortedByDescending { it }  
        // 5. 작업3가 완료된다.  
    }  
    val job1 = CoroutineScope(Dispatchers.Main).launch {  
        // 1. Main Thread에서 작업1을 수행한다.  
        println(1)  
        // 3. 작업1의 남은 작업을 위해 작업3로부터 결과값이 필요하기 때문에 Main Thread는 작업1을 일시중단한다.  
        val job3Result = job3.await()  
        // 6. 작업3로부터 결과를 전달받는다.  
  
        // 7. 작업1이 재개된다.        job3Result.forEach {  
            println(it)  
        }  
    }  
    // 4. Main Thread에서 작업2이 수행되고 완료된다.  
    val job2 = CoroutineScope(Dispatchers.Main).launch {  
        println("Job2 수행완료")  
    }  
}
```


1. Main Thread의 Coroutine1에서 작업1(job1)이 수행되며 Main Thread의 자원을 점유한다.
2. IO Thread의 Coroutine3에서 작업3(job3)가 수행되며 IO Thread의 자원을 점유한다.
3. Coroutine1에서 Coroutine3의 작업3의 결과가 필요한 작업이 나온다. 이때 Coroutine1은 일시중단된다.
4. Coroutine2가 Main Thread를 점유하여 작업2를 수행하고 완료한다.
5. Coroutine3의 작업3이 완료된다. 
6. Coroutine1은 작업3의 결과를 전달받는다.
7. Coroutine1이 재개된다.
8. 
job3(작업3)는 IO Thread위에서 수행되는 async 작업이며 결과값을 반환받는 작업이다. 1부터 10000까지를 내림차순으로 정렬해서 반환받는 작업이다보니 job1(작업1)의 println(1)보다는 많은 시간을 소모할 수 밖에 없다. 

이 때문에 job1 코루틴은 job3의 결과를 기다려야만 한다. 따라서 중간에 일시 중단 하는 단계가 필요하다. 비동기 작업을 하다보면 이러한 상황을 맞딱뜨리는 경우가 많은데, 이때 코루틴에서는 해당 코루틴 작업을 잠시 일시 중단 가능하도록 한다. 이 때문에 일시 중단 가능한 함수는 코루틴 내부에서 수행되어야 한다.


### 코루틴 일시 중단은 코루틴 내부에서 수행되어야 한다.
만약 일시 중단을 코루틴 블록(launch 혹은 async) 내부에서 수행하지 않으면 어떻게 될까?
![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2Fdq8iBq%2FbtrcLCgnB0H%2F854rdnyrbzLODFODPLJ7jK%2Fimg.png)
바로 일시 중단 함수로 바꾸라는 오류가 생기게 된다. 코루틴이 일시중단이 되려면 수행되는 위치 또한 코루틴 내부여야 하기 때문이다. 이를 해결하는 방법은 두가지이다. 첫 째는 일시 중단 작업을 코루틴 내부로 옮기는 것이고, 다른 하나는 fun를 suspend fun(일시중단 가능 함수)로 만드는 것이다.

### 일시 중단 해당 작업을 코루틴 내부로 옮기기
일시 중단 가능한 작업이 코루틴 내부로 옮겨지면 해당 코루틴은 결과값이 나올때 까지 일시 중단 되기 때문에 오류가 사라진다.

fun을 suspend fun으로 바꾸면 함수(fun) 블록에서는 오류가 사라진다. 하지만 그림3에서 볼 수 있듯이 suspend fun를 외부에서 별도 처리 없이 수행하면 오류가 생기는 것을 볼 수 있다.

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2FbPD9TW%2FbtrcNnivMbi%2FoiCTuKsgQuPuoJ8ziV9iBk%2Fimg.png)

이유는 suspend fun는 일시중단 가능한 함수를 지칭하는 것이기 때문에, 해당 함수는 무조건 코루틴 내부에서 수행되어야 하기 때문이다. 따라서 <그림3>의 코드는 <그림4>와 같이 코루틴 블록 내에서 수행하도록 바뀌면 오류가 사라진다.

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2FyXJ6p%2FbtrcNlSuUCJ%2FHhRaoNu8apCxycEKpWVT5K%2Fimg.png)

### 정리
-   코루틴의 일시 중단 기능은 코루틴 내부에서만 수행할 수 있다. 
-   suspend fun는 일시 중단 가능한 함수로, 해당 함수 내에 일시 중단이 가능한 작업이 있다는 것을 뜻한다.
-   따라서 suspend fun은 코루틴 내부에서 또는 suspend fun 내부에서만 사용할 수 있다.


