
---
title: 6.1 다대일
date: 2022-11-04
type:  blog
author: harris baek
email: baekjh09@naver.com
---
tags: #spring , #backend , #db, #jpa 

### 엔티티 연관관계 매핑 시 고려사항
1. 다중성 
	- 다대일(`@ManyToOnet`),일대다(`@oneToMany`),일대일(`OneToOne`),다대다(`ManyToMany`)
	- 다중성을 판단하기 어려울 때는 반대 방향을 생각해본다.
	- 일대다의 반대방향은 항상 다대일, 일대일의 반대방향은 항상 일대일

2. 단방향, 양방향
	- 단방향 관계 : 객체 관계에서 한 쪽만 참조하는것
	- 양방향 관계 : 양쪽이 서로 참조하는 것

3. 연관관계의 주인
	- 엔티티 양방향 매핑 시 2곳에서 서로를 참조한다. -> 객체의 연관관계 관리 포인트 2곳
	- JPA는 두 객체 연관관계 중 하나를 정해서 데이터베이스 외래 키를 관리한다. -> 연관관계의 주인을 설정한다.
	- 주인이 아닌 방향은 외래 키를 변경할 수 잆고 읽기만 가능한다.

## 6.1.1 다대일 단방향

`다대일 관계`의 반대 방향은 항상 `일대다 관계`
`일대다 관계`의 반대 방향은 항상 `다대일 관계`
외래 키는 항상 다쪽에 있다 -> 객체 양방향 관계에서 연관관계의 주인은 항상 다쪽인다.

회원은 Member.team으로 팀 엔티티 참조 가능
반대로 팀에서 회원은 참조하는 필드가 없어서 참조 불가능

![](https://user-images.githubusercontent.com/51476083/118161418-84066500-b45a-11eb-8f83-20e37657ba95.png)

### 회원 엔티티
```java
@Entity
public class Member {
    @Id @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;
    private String username;
    
    @ManyToOne
    @JoinColumn(name = "TEAM_ID") // TEAM_ID 외래 키와 매핑
    private Team team;
    // Getter, Setter ...
    ...
}
```

### 팀 엔티티
```java
@Entity
public class Team {
    @Id @GeneratedValue
    @Column(name = "TEAM_ID")
    private Long id;
    private String name;
    // Getter, Setter ...
    ...
}
```

---

## 6.1.2 다대일 양방향

다대일 양방향의 객체 연관관계에서 실선이 연관관의 주인(Member.team)이고 점선(Team.members)은 연관관계의 주인이 아니다.

![](https://user-images.githubusercontent.com/51476083/118161511-a5675100-b45a-11eb-9721-068195f82216.png)


1. 양방향은 외래 키가 있는 쪽이 연관관계의 주인이다.
	- 일대다와 다대일 연관관계는 항상 다에 외래 키가 있다.
	- 다쪽인 MEMBER테이블이 외래 키를 가지고 있으므로 Member.team 이 연관관계의 주인
	- JPA는 외래 키 관리 시 연관관계의 주인만 사용. 주인이 아닌 Team.members는 조회를 위한 JPQL이나 객체 그래프 탐색할 때 사용
	
2. 양방향 연관관계는 항상 서로 참조해야 한다.
	- 어느 한 쪽만 참조하면 양방향 연관관계가 성립되지 않는다.
	- 연관관계 편의 메소드를 작성하여 양방향 연관관계를 하나의 메소드에서 처리하도록 한다.


### 회원 엔티티

```java
@Entity
public class Member {
    @Id @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;
    private String username;

    @ManyToOne
    @JoinColumn(name = "TEAM_ID") // TEAM_ID 외래 키와 매핑
    private Team team;
    public void setTeam(Team team){
        this.team = team;
        // 무한루프에 빠지지 않도록 체크
        if(!team.getMembers().contains(this)){
            team.getMembers().add(this);
        }
    }
    // Getter, Setter ...
    ...
}
```


### 팀 엔티티
```java
import java.util.ArrayList;
@Entity
public class Team {
  @Id
  @GeneratedValue
  @Column(name = "TEAM_ID")
  private Long id;
  private String name;
  
  @OneToMany(mappedBy = "team")
  private List<Member> members = new ArrayList<Member>();
  public void addMember(Member member){
      this.members.add(member);
      if(member.getTeam != this) { // 무한루프에 빠지지 않도록 체크
          member.setTeam(this);
      }
  }
  // Getter, Setter ...
    ...
}
```