---
title: 3. 기본 회원관리 프로그램
date: 2022-10-15
type:  blog
author: harris baek
email: baekjh09@naver.com
---
tags:  #spring, #backend
 
### 비즈니스 요구사항 정리  


```ad-info
- 회원 도메인과 리포지토리 만들기 
- 회원 __레포지토리 테스트__ 작성 
- 회원 서비스 개발  
- 회원 서비스 테스트
```
 
![[excalidraw_system_main.png]]


![[3_class_diagram.png]]

일단 DB를 무엇을 사용할지 정해지지 않았기 때문에 MemberRepository를 Interface로 구현하여 실제 구현체와 분리하여 개발한다.

---


###  기본적인 개발 방법
- 기능 Class를 개발하면 JUnit5를 이용하여 Testcase와 매칭 하여 개발한다.
-  기본적인 아키텍처는 MVC 모델에서 View - Controller -  Service - Repository - Database로 이어지는  형태의 클린 아키텍처를 지양하고 있는것으로 보인다 ( 안드로이드의 기본적인 View - ViewModel - Service -Repository - Database와 비슷함)

![[excalidraw_clean_arch.png]]

![](obsidian://open?vault=obsidian&file=Development%2FWeb%2FSpringBoot%2FBasic%2Fassets%2Fexcalidraw%2F2022-10-19%2012.19.14.excalidraw)

###  1. Repository 및 Member
#### 1.1 Repository 및  Member 클래스 구현 코드
```java  
//Member (회원 클래스 - Model) 
package hello.hellospring.domain; 

public class Member { 
	private Long id; 
	private String name; 
	
	public Long getId() { return id; } 
	public void setId(Long id) { this.id = id; } 
	
	public String getName() { return name; } 
	public void setName(String name) { this.name = name; } }

```

```java
package hello.hellospring.repository; 

import hello.hellospring.domain.Member; 
import java.util.List; 
import java.util.Optional; 

//실제 DB와 연관되는 Repository Class
public interface MemberRepository { 
	//DB에서 4개 기능을 제공해줌
	Member save(Member member); 
	Optional findById(Long id); 
	Optional findByName(String name); 
	List findAll();
}
```

```java

package hello.hellospring.repository; 

import hello.hellospring.domain.Member; 
import java.util.*; 


/** 
* 동시성  문제가 고려되어 있지 않음, 실무에서는 ConcurrentHashMap, AtomicLong 사용 고려 
* 실제 repository 구현체 - 테스트를 위해서 메모리에 HashMap으로 구현 
* */ 
public class MemoryMemberRepository implements MemberRepository { 

	private static Map store = new HashMap<>(); 
	private static long sequence = 0L; 
	
	@Override 
	public Member save(Member member) { 
		member.setId(++sequence); 
		store.put(member.getId(), member); 
		return member; 
	} 
	@Override 
	public Optional findById(Long id) { 
		return Optional.ofNullable(store.get(id)); 
	} 
	@Override public List findAll() { return new ArrayList<>(store.values()); } 
	@Override 
	public Optional findByName(String name) { 
		return store.values().stream() 
		.filter(member -> member.getName().equals(name)) .findAny(); 
	} 
	public void clearStore() { store.clear(); } }
```



#### 1.2 Repository 및 Member 클래스 테스트 코드(Junit5)

``` ad-info
title: 테스트 코드 작성법
테스트 코드의 경운에는 Given - When -Then 3단계로 코드를 구성

(1) given : 경우 주어진 사전 환경

(2) when : 실제 어떤한 action 

(3) then : 그 액션이 일어난 이후의 결과에 대해서 서술하면서 테스트 코드 작성

또한 테스트 케이스의 경우 각각이 독립적으로 테스트 될수 있도록 before, after를 잘 설정한다.

```


```java
package com.example.hello.hellospring.repository;  
  
import com.example.hello.hellospring.domain.Member;  
import org.assertj.core.api.Assertions;  
import org.junit.jupiter.api.AfterEach;  
import org.junit.jupiter.api.Test;  
  
import java.util.List;  
  
public class MemoryMemberRepositoryTest {  
  
    MemberRepository repository = new MemoryMemberRepository();  
  
    @AfterEach  
    public void tearDown(){  
        repository.clearRepository();  
    }  
  
  
    @Test  
    public void save(){  
        Member member = new Member();  
        member.setName("spring");  
  
        repository.save(member);  
  
        Member result = repository.findById(member.getId()).get();  
  
        Assertions.assertThat(member).isEqualTo(result);  
    }  
  
    @Test  
    public void findBydName(){  
        Member member1 = new Member();  
        member1.setName("spring1");  
        repository.save(member1);  
  
        Member member2 = new Member();  
        member2.setName("spring2");  
        repository.save(member2);  
  
        Member result = repository.findById(1L).get();  
        Assertions.assertThat(member1).isEqualTo(result);  
    }  
  
    @Test  
    public void findAll(){  
        Member member1 = new Member();  
        member1.setName("spring1");  
        repository.save(member1);  
  
        Member member2 = new Member();  
        member2.setName("spring2");  
        repository.save(member2);  
  
        List<Member> result = repository.findAll();  
  
    }  
  
}
```


### 2. 회원 서비스 개발 (실제 서비스 기능)
#### 2.1 회원 서비스 구현 코드
```java
package com.example.hello.hellospring.service;  
  
import com.example.hello.hellospring.domain.Member;  
import com.example.hello.hellospring.repository.MemberRepository;  
import com.example.hello.hellospring.repository.MemoryMemberRepository;  
import org.springframework.beans.factory.annotation.Autowired;  
import org.springframework.stereotype.Service;  
  
import java.nio.channels.IllegalChannelGroupException;  
import java.util.List;  
import java.util.Optional;  
  
public class MemberService {  
  
    //이게 새로 객체마다 새로 생성될 가능성이 있으므로, 외부에서 넣어주도록 변경한다.  
    private final MemberRepository memberRepository;  
  
    @Autowired  
    public MemberService(MemberRepository repository) {  
        this.memberRepository = repository;  
    }  
  
	public Long join(Member member) {  
        validateDuplicateMember(member);  
        memberRepository.save(member);  
        return member.getId();  
  
    }  
    private void validateDuplicateMember(Member member) {  
        memberRepository.findByName(member.getName()).ifPresent(name -> {  
            throw new IllegalStateException("error - exists member!");  
        });  
    }  
  
   public List<Member> findMembers() {  
        return memberRepository.findAll();  
    }  
  
  
    //Null일때 사용 가능하다. Optional좋아여  
    public Optional<Member> findMember(Long memberId) {  
        return memberRepository.findById(memberId);  
    }  
}
```

#### 2.2 회원 서비스 테스트 코드
```java

package com.example.hello.hellospring.service;  
  
import com.example.hello.hellospring.domain.Member;  
import com.example.hello.hellospring.repository.MemberRepository;  
import com.example.hello.hellospring.repository.MemoryMemberRepository;  
import org.assertj.core.api.Assertions;  
import org.junit.jupiter.api.AfterEach;  
import org.junit.jupiter.api.BeforeEach;  
import org.junit.jupiter.api.Test;  
  
import static org.junit.jupiter.api.Assertions.*;  
  
class MemberServiceTest {  
  
    MemberService memberService;  
    MemberRepository memberRepository;  
  
  
    @BeforeEach  
    public void beforeEach(){  
        memberRepository = new MemoryMemberRepository();  
        memberService = new MemberService(memberRepository);  
    }  
    @AfterEach  
    public void afterEach(){  
        memberRepository.clearRepository();  
    }  
  
    @Test  
    void join() {  
        //given  
        Member member = new Member();  
        member.setName("Hello");  
  
        //when  
        Long saveId = memberService.join(member);  
  
        //then  
        Member findMember = memberService.findMember(saveId).get();  
        Assertions.assertThat(member.getName()).isEqualTo(findMember.getName());  
    }  
  
    @Test  
    public void exception_join(){  
        //given  
        Member member1 = new Member();  
        member1.setName("spring");  
  
        Member member2 = new Member();  
        member2.setName("spring");  
  
        //when  
        memberService.join(member1);  
        assertThrows(IllegalStateException.class, () -> memberService.join(member2));  
    }  
}

```

### 3. 스프링 빈과의 의존 관계
- 스프링은 컨테이너에 저장된 스프링 빈들을 통해서 각 필요한 객체들을 자동으로 주입해 준다.(Dependency Injection)


#### 3.1 스프링 빈을 등록 하는 2가지 방법
1. 특정 어노테이션을 입력하여 컴포넌트 스캔을 통한 자동 의존관계 설정
2. `@Config, @Bean`  어노테이션을 통한 수동 등록

```ad-warning
title: 스프링 빈 객체
스프링은 스프링 컨테이너에 스프링 빈을 등록할 때, 기본으로 싱글톤으로 등록한다. 따라서 DI를 통해 주입이 되었다면 모두 같은 인스턴스이다.
```


##### 1. 컴포넌트 스캔
- 스프링 메인(Application)을 시작하면 컴포넌트 스캔을 진행 하며, 빈으로 등록 되어진 클래스들을 수집한다.
- @Component가 선언되어져 있는 @Controller, @Service, @Repository, @Bean은 자동으로 등록된다.
-  @Autowired가 있으면 스프링이 연관된  Bean객체를 컨테이너에서 찾아서 넣어준다. 이것을 Dependency Injection 이라고 부른다.

```ad-note
title: 컴포넌트 스캔
첫 스프링 시작시에 @componentscan 어노테이션을 통해서 전체 컴포넌트를 스캔한다.<br/>
![[component_scan.png]]


아래 그림과 같이 @Controller, @Service, @Repository등이 선언되어있으면 컨테이너에서 자동으로 스프링 빈으로 등록 하여 관리하며, @Autowired를 달면 자동으로 주입하여 준다.


![[component_annotation.png]]
```


##### 2. 자바 코드로 직접 스프링 빈 등록하기
- 별도의 어노테이션 없이 Config 파일에 등록된 객체들을 매뉴얼로 스프링 빈으로 등록 해준다.
- @Configuration 어노테이션이 있는 클래스 내부를 찾아서 @Bean 어노테이션이 달리 메소드들을 찾아서 적정한 객체를 주입시켜 준다.
```java
package com.example.hello.hellospring.config;  
  
  
import com.example.hello.hellospring.repository.MemberRepository;  
import com.example.hello.hellospring.repository.MemoryMemberRepository;  
import com.example.hello.hellospring.service.MemberService;  
import org.springframework.context.annotation.Bean;  
import org.springframework.context.annotation.Configuration;  
  
@Configuration  
public class SpringConfig {  
  
    @Bean  
    public MemberService memberService() {  
        return new MemberService(memberRepository());  
    }  
  
    @Bean  
    public MemberRepository memberRepository() {  
        return new MemoryMemberRepository();  
    }  
}
```


### 4. 회원 웹 기능 - 회원가입

#### 4.1 Intro 화면 개발

- HomeController를 추가하여 첫 진입시 home()으로 진입하게 하고, templates/home.html을  return한다.
-
```java

//첫 백엔드 진입 시 호출됨 (return home.html)
package com.example.hello.hellospring.contoller;  
  
import org.springframework.stereotype.Controller;  
import org.springframework.web.bind.annotation.GetMapping;  
  
@Controller  
public class HomeController {  
  
    @GetMapping("/")  
    public String home(){  
        return "home";  
    }  
}
```

```html
<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <title>Title</title>  
</head>  
<body>  
<div class="container">  
    <div>        <h1>Hello Spring</h1>  
        <p>회원 기능</p>  
        <p>
            <a href="/members/new">회원 가입</a> <br>  
            <a href="/members">회원 목록 </a>  
        </p>    </div></div>  
</body>  
</html>
```

#### 4.2 회원 가입
- 홈에서 get - "members/new"으로 온 애를 받아줄수있는 MemberController를 생성한다.
- 이후 회원가입 양식이 있는 createMemberForm.html 전달 한다.
- html에서 입력된 가입 양식을 담을수 있는 Form class를 생성한다.
- 입력된 정보를 Form class에  담아서 Post - "members/new" 보낸다

```java
package com.example.hello.hellospring.contoller;  
  
import com.example.hello.hellospring.domain.Member;  
import com.example.hello.hellospring.service.MemberService;  
import org.springframework.beans.factory.annotation.Autowired;  
import org.springframework.stereotype.Controller;  
import org.springframework.web.bind.annotation.GetMapping;  
import org.springframework.web.bind.annotation.PostMapping;  
  
@Controller  
public class MemberController {  
  
    private final MemberService memberService;  
  
    @Autowired  
    public MemberController(MemberService memberService) {  
        this.memberService = memberService;  
    }  
  
    @PostMapping("members/new")  
    public String create(MemberForm form){  
        Member member = new Member();  
        member.setName(form.getName());  
  
        memberService.join(member);  
        return "redirect:/";  
    }  
  
    @GetMapping("members/new")  
    public String createForm(){  
        return "members/createMemberForm";  
    }  
}
```

```html
<!DOCTYPE HTML>  
<html xmlns:th="http://www.thymeleaf.org">  
<body>  
<div class="container">  
    <form action="/members/new" method="post">  
        <div class="form-group">  
            <label for="name">이름</label>  
            <input type="text" id="name" name="name" placeholder="이름을입력하세요">  
        </div>        <button type="submit">등록</button>  
    </form></div> <!-- /container -->  
</body>  
  
</html>

```

```java
package com.example.hello.hellospring.contoller;  
  
public class MemberForm {  
    private String name;  
  
    public String getName() {  
        return name;  
    }  
  
    public void setName(String name) {  
        this.name = name;  
    }  
}
```


#### 4.3 회원 조회
- 전체 회원을 조회해서 적어주는것 까지 완료
- Home에서 회원 목록을 클릭하면 `/members/memberList` 로 전달되며 여기에 전체 회원정보를 보여줌

```java
@GetMapping("/members")  
public String list(Model model){  
    List<Member> members = memberService.findMembers();  
    model.addAttribute("members", members);  
  
    return "/members/memberList";  
}

```
```html
<!DOCTYPE HTML>  
<html xmlns:th="http://www.thymeleaf.org">  
<body>  
<div class="container">  
  <div>    
	  <table>      
		  <thead>      
		  <tr>        
			  <th>#</th>  
		      <th>이름</th>  
	      </tr>      
	      </thead>      
	      <tbody>      
		      <tr th:each="member : ${members}">  
		        <td th:text="${member.id}"></td>  
		        <td th:text="${member.name}"></td>  
		      </tr>      
		</tbody>    
		</table> 
	</div>
</div> <!-- /container -->  
</body>  
</html>
```

